
<!DOCTYPE html>

<html>
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Retrieval &#8212; pyRT_DISORT  documentation</title>
    
  <link href="../../../../_static/css/theme.css" rel="stylesheet" />
  <link href="../../../../_static/css/index.c5995385ac14fb8791e8eb36b4908be2.css" rel="stylesheet" />

    
  <link rel="stylesheet"
    href="../../../../_static/vendor/fontawesome/5.13.0/css/all.min.css">
  <link rel="preload" as="font" type="font/woff2" crossorigin
    href="../../../../_static/vendor/fontawesome/5.13.0/webfonts/fa-solid-900.woff2">
  <link rel="preload" as="font" type="font/woff2" crossorigin
    href="../../../../_static/vendor/fontawesome/5.13.0/webfonts/fa-brands-400.woff2">

    
      

    
    <link rel="stylesheet" type="text/css" href="../../../../_static/pygments.css" />
    <link rel="stylesheet" type="text/css" href="../../../../_static/basic.css" />
    <link rel="stylesheet" type="text/css" href="../../../../_static/plot_directive.css" />
    
  <link rel="preload" as="script" href="../../../../_static/js/index.1c5a1a01449ed65a7b51.js">

    <script data-url_root="../../../../" id="documentation_options" src="../../../../_static/documentation_options.js"></script>
    <script src="../../../../_static/jquery.js"></script>
    <script src="../../../../_static/underscore.js"></script>
    <script src="../../../../_static/doctools.js"></script>
    <link rel="index" title="Index" href="../../../../genindex.html" />
    <link rel="search" title="Search" href="../../../../search.html" />
    <link rel="next" title="API reference" href="../../api-reference.html" />
    <link rel="prev" title="Running the model" href="running_the_model.html" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <meta name="docsearch:language" content="en" />
    
  </head>
  <body data-spy="scroll" data-target="#bd-toc-nav" data-offset="80">
    
    <div class="container-fluid" id="banner"></div>

    
    <nav class="navbar navbar-light navbar-expand-lg bg-light fixed-top bd-navbar" id="navbar-main"><div class="container-xl">

  <div id="navbar-start">
    
    
<a class="navbar-brand" href="../../../../index.html">
<p class="title">pyRT_DISORT</p>
</a>

    
  </div>

  <button class="navbar-toggler" type="button" data-toggle="collapse" data-target="#navbar-collapsible" aria-controls="navbar-collapsible" aria-expanded="false" aria-label="Toggle navigation">
    <span class="navbar-toggler-icon"></span>
  </button>

  
  <div id="navbar-collapsible" class="col-lg-9 collapse navbar-collapse">
    <div id="navbar-center" class="mr-auto">
      
      <div class="navbar-center-item">
        <ul id="navbar-main-elements" class="navbar-nav">
    <li class="toctree-l1 nav-item">
 <a class="reference internal nav-link" href="../../../about-this-project/about-pyRT_DISORT.html">
  About pyRT_DISORT
 </a>
</li>

<li class="toctree-l1 nav-item">
 <a class="reference internal nav-link" href="../../../about-this-project/about-DISORT.html">
  About DISORT
 </a>
</li>

<li class="toctree-l1 nav-item">
 <a class="reference internal nav-link" href="../../../about-this-project/release-notes.html">
  Release notes
 </a>
</li>

<li class="toctree-l1 nav-item">
 <a class="reference internal nav-link" href="../../installation.html">
  Installation
 </a>
</li>

<li class="toctree-l1 current active nav-item">
 <a class="reference internal nav-link" href="../../tutorials.html">
  Tutorials
 </a>
</li>

<li class="toctree-l1 nav-item">
 <a class="reference internal nav-link" href="../../api-reference.html">
  API reference
 </a>
</li>

<li class="toctree-l1 nav-item">
 <a class="reference internal nav-link" href="../../../for-contributors/contributions.html">
  Contributions
 </a>
</li>

    
</ul>
      </div>
      
    </div>

    <div id="navbar-end">
      
      <div class="navbar-end-item">
        <ul id="navbar-icon-links" class="navbar-nav" aria-label="Icon Links">
        <li class="nav-item">
          <a class="nav-link" href="https://github.com/kconnour/pyRT_DISORT" rel="noopener" target="_blank" title="GitHub">
            <span><i class="fab fa-github-square"></i></span>
            <label class="sr-only">GitHub</label>
          </a>
        </li>
      </ul>
      </div>
      
    </div>
  </div>
</div>
    </nav>
    

    <div class="container-xl">
      <div class="row">
          
            
            <!-- Only show if we have sidebars configured, else just a small margin  -->
            <div class="col-12 col-md-3 bd-sidebar"><form class="bd-search d-flex align-items-center" action="../../../../search.html" method="get">
  <i class="icon fas fa-search"></i>
  <input type="search" class="form-control" name="q" id="search-input" placeholder="Search the docs ..." aria-label="Search the docs ..." autocomplete="off" >
</form><nav class="bd-links" id="bd-docs-nav" aria-label="Main navigation">
  <div class="bd-toc-item active">
    <p class="caption" role="heading">
 <span class="caption-text">
  Retrievals from scratch
 </span>
</p>
<ul class="current nav bd-sidenav">
 <li class="toctree-l1 current active has-children">
  <a class="reference internal" href="../spacecraft_retrieval.html">
   Spacecraft Retrieval
  </a>
  <input checked="" class="toctree-checkbox" id="toctree-checkbox-1" name="toctree-checkbox-1" type="checkbox"/>
  <label for="toctree-checkbox-1">
   <i class="fas fa-chevron-down">
   </i>
  </label>
  <ul class="current">
   <li class="toctree-l2">
    <a class="reference internal" href="observation.html">
     The observation module
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="eos.html">
     The eos module
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="rayleigh.html">
     The rayleigh module
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="aerosol.html">
     The aerosol module
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="atmosphere.html">
     The atmosphere module
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="controller.html">
     The controller module
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="radiation.html">
     The radiation module
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="output.html">
     The output module
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="surface.html">
     The surface module
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="running_the_model.html">
     Running the model
    </a>
   </li>
   <li class="toctree-l2 current active">
    <a class="current reference internal" href="#">
     Retrieval
    </a>
   </li>
  </ul>
 </li>
</ul>

  </div>
</nav>
            </div>
            
          

          
          <div class="d-none d-xl-block col-xl-2 bd-toc">
            
              
              <div class="toc-item">
                

<nav id="bd-toc-nav">
    
</nav>
              </div>
              
              <div class="toc-item">
                
              </div>
              
            
          </div>
          

          
          
            
          
          <main class="col-12 col-md-9 col-xl-7 py-md-5 pl-md-5 pr-md-4 bd-content" role="main">
              
              <div>
                
  <div class="section" id="retrieval">
<h1>Retrieval<a class="headerlink" href="#retrieval" title="Permalink to this headline">¶</a></h1>
<p>We were able to make simulations in the previous section, but now let’s suppose
we want to retrieve the dust optical depth (instead of treating it as a fixed
quantity). All that we really need to do is run simulations with a bunch of
different optical depths and see which one matches an observation the best
… though the implementation details aren’t quite so crude. To demonstrate how
to do this, I ran this code with a a dust optical depth known only to me and
I’ll show you how to get this value from what we’ve written.</p>
<p>Let’s suppose we measured the following reflectance (I/F) spectrum at the input
set of wavelengths (this was the result of my simulation).</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">rfl</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mf">0.116</span><span class="p">,</span> <span class="mf">0.108</span><span class="p">,</span> <span class="mf">0.084</span><span class="p">,</span> <span class="mf">0.094</span><span class="p">,</span> <span class="mf">0.092</span><span class="p">])</span>
</pre></div>
</div>
<p>If we want to retrieve a scalar optical depth over this spectral range
we want a function that accepts a test optical depth and finds the optical
depth that best fits this spectrum. The following function does that</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">test_optical_depth</span><span class="p">(</span><span class="n">test_od</span><span class="p">):</span>
    <span class="c1"># Trap the guess</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="mi">0</span> <span class="o">&lt;=</span> <span class="n">test_od</span> <span class="o">&lt;=</span> <span class="mi">2</span><span class="p">:</span>
        <span class="k">return</span> <span class="mi">9999999</span>

    <span class="n">od</span> <span class="o">=</span> <span class="n">OpticalDepth</span><span class="p">(</span><span class="n">dust_profile</span><span class="p">,</span> <span class="n">hydro</span><span class="o">.</span><span class="n">column_density</span><span class="p">,</span> <span class="n">fs</span><span class="o">.</span><span class="n">extinction</span><span class="p">,</span>
                       <span class="n">test_od</span><span class="p">)</span>

    <span class="n">dust_info</span> <span class="o">=</span> <span class="p">(</span><span class="n">od</span><span class="o">.</span><span class="n">total</span><span class="p">,</span> <span class="n">dust_ssa</span><span class="p">,</span> <span class="n">dust_pf</span><span class="p">)</span>
    <span class="n">model</span> <span class="o">=</span> <span class="n">Atmosphere</span><span class="p">(</span><span class="n">rayleigh_info</span><span class="p">,</span> <span class="n">dust_info</span><span class="p">)</span>

    <span class="n">od_holder</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">n_wavelengths</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">wav_index</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">n_wavelengths</span><span class="p">):</span>
        <span class="n">rfldir</span><span class="p">,</span> <span class="n">rfldn</span><span class="p">,</span> <span class="n">flup</span><span class="p">,</span> <span class="n">dfdt</span><span class="p">,</span> <span class="n">uavg</span><span class="p">,</span> <span class="n">uu</span><span class="p">,</span> <span class="n">albmed</span><span class="p">,</span> <span class="n">trnmed</span> <span class="o">=</span> \
             <span class="n">disort</span><span class="o">.</span><span class="n">disort</span><span class="p">(</span><span class="n">USRANG</span><span class="p">,</span> <span class="n">USRTAU</span><span class="p">,</span> <span class="n">IBCND</span><span class="p">,</span> <span class="n">ONLYFL</span><span class="p">,</span> <span class="n">PRNT</span><span class="p">,</span> <span class="n">PLANK</span><span class="p">,</span> <span class="n">LAMBER</span><span class="p">,</span>
                           <span class="n">DELTAMPLUS</span><span class="p">,</span> <span class="n">DO_PSEUDO_SPHERE</span><span class="p">,</span>
                           <span class="n">model</span><span class="o">.</span><span class="n">optical_depth</span><span class="p">[:,</span> <span class="n">wav_index</span><span class="p">],</span>
                           <span class="n">model</span><span class="o">.</span><span class="n">single_scattering_albedo</span><span class="p">[:,</span> <span class="n">wav_index</span><span class="p">],</span>
                           <span class="n">model</span><span class="o">.</span><span class="n">legendre_moments</span><span class="p">[:,</span> <span class="p">:,</span> <span class="n">wav_index</span><span class="p">],</span>
                           <span class="n">TEMPER</span><span class="p">,</span> <span class="n">WVNMLO</span><span class="p">,</span> <span class="n">WVNMHI</span><span class="p">,</span>
                           <span class="n">UTAU</span><span class="p">,</span> <span class="n">UMU0</span><span class="p">,</span> <span class="n">PHI0</span><span class="p">,</span> <span class="n">UMU</span><span class="p">,</span> <span class="n">PHI</span><span class="p">,</span> <span class="n">FBEAM</span><span class="p">,</span> <span class="n">FISOT</span><span class="p">,</span>
                           <span class="n">ALBEDO</span><span class="p">,</span> <span class="n">BTEMP</span><span class="p">,</span> <span class="n">TTEMP</span><span class="p">,</span> <span class="n">TEMIS</span><span class="p">,</span> <span class="n">EARTH_RADIUS</span><span class="p">,</span> <span class="n">H_LYR</span><span class="p">,</span> <span class="n">RHOQ</span><span class="p">,</span> <span class="n">RHOU</span><span class="p">,</span>
                           <span class="n">RHO_ACCURATE</span><span class="p">,</span> <span class="n">BEMST</span><span class="p">,</span> <span class="n">EMUST</span><span class="p">,</span> <span class="n">ACCUR</span><span class="p">,</span> <span class="n">HEADER</span><span class="p">,</span> <span class="n">RFLDIR</span><span class="p">,</span>
                           <span class="n">RFLDN</span><span class="p">,</span> <span class="n">FLUP</span><span class="p">,</span> <span class="n">DFDT</span><span class="p">,</span> <span class="n">UAVG</span><span class="p">,</span> <span class="n">UU</span><span class="p">,</span> <span class="n">ALBMED</span><span class="p">,</span> <span class="n">TRNMED</span><span class="p">)</span>

        <span class="n">od_holder</span><span class="p">[</span><span class="n">wav_index</span><span class="p">]</span> <span class="o">=</span> <span class="n">uu</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span>
    <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">((</span><span class="n">od_holder</span> <span class="o">-</span> <span class="n">rfl</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span>
</pre></div>
</div>
<p>This function is worth explaining. The <code class="code docutils literal notranslate"><span class="pre">if</span></code> statement allows me to
specify some physical boundaries—if the input optical depth is outside an
acceptable range, I return a huge value. Next, I realize that if I only want to
retrieve the dust optical depth, nothing in this guide before the place where
I define the optical depth is affected; that is, the equation of state,
input angles, input wavelengths, etc. don’t need modification. In fact, only
the atmospheric model cares about the different optical depths.
Finally, I create an empty array that will hold the values
as DISORT is run at each of the wavelengths (just like before) and populate
it along the way, but I only return the square of the distance from the target
spectrum. This essentially tells us how close the input optical depth is to the
target. If we minimize the output of this function, we found the best fit dust
optical depth.</p>
<p>Fortunately, scipy has some minimization routines for just this sort of thing.
I’ll use their Nelder-Mead algorithm (a slower but robust algorithm) but feel
free to use another one if you’ve got more familiarity with them. All we need
to do is provide it a function to minimize (which we just defined) along with
an initial guess.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">scipy</span> <span class="kn">import</span> <span class="n">optimize</span>


<span class="k">def</span> <span class="nf">retrieve_od</span><span class="p">(</span><span class="n">guess</span><span class="p">):</span>
    <span class="k">return</span> <span class="n">optimize</span><span class="o">.</span><span class="n">minimize</span><span class="p">(</span><span class="n">test_optical_depth</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">guess</span><span class="p">]),</span>
                             <span class="n">method</span><span class="o">=</span><span class="s1">&#39;Nelder-Mead&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">x</span>
</pre></div>
</div>
<p>Now let’s do a retrieval where we guess that the optical depth is 1 and see how
long it takes to run.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">time</span>

<span class="n">t0</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
<span class="nb">print</span><span class="p">(</span><span class="n">retrieve_od</span><span class="p">(</span><span class="mi">1</span><span class="p">))</span>
<span class="n">t1</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;The retrieval took </span><span class="si">{</span><span class="p">(</span><span class="n">t1</span> <span class="o">-</span> <span class="n">t0</span><span class="p">)</span><span class="si">:</span><span class="s1">.3f</span><span class="si">}</span><span class="s1"> seconds.&#39;</span><span class="p">)</span>
</pre></div>
</div>
<p>On my aging computer this outputs</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="p">[</span><span class="mf">0.2359375</span><span class="p">]</span>
<span class="n">The</span> <span class="n">retrieval</span> <span class="n">took</span> <span class="mf">0.699</span> <span class="n">seconds</span><span class="o">.</span>
</pre></div>
</div>
<p>I originally ran the simulation with an optical depth of 0.234 so our solver
worked pretty accurately. It was also pretty fast! Be aware that the time will
increase significantly if you’re fitting multiple parameters, such as multiple
aerosol optical depths.</p>
<p>Hopefully you see the benefit of building a model piece by piece—you only
need to repeat the steps that change as you iterate over the parameter(s).
Radiative transfer has a reputation of being computationally intensive. This
won’t change that, but it’s an attempt to make your model as efficient as
possible. Next, we’ll look at how to parallelize the code we just wrote (once
I’m feeling up for it).</p>
</div>


              </div>
              
              
              <div class='prev-next-bottom'>
                
    <a class='left-prev' id="prev-link" href="running_the_model.html" title="previous page">Running the model</a>
    <a class='right-next' id="next-link" href="../../api-reference.html" title="next page">API reference</a>

              </div>
              
          </main>
          

      </div>
    </div>
  
  <script src="../../../../_static/js/index.1c5a1a01449ed65a7b51.js"></script>

  <footer class="footer mt-5 mt-md-0">
  <div class="container">
    
    <div class="footer-item">
      <p class="copyright">
    &copy; Copyright 2021, kconnour.<br/>
</p>
    </div>
    
    <div class="footer-item">
      <p class="sphinx-version">
Created using <a href="http://sphinx-doc.org/">Sphinx</a> 4.1.2.<br/>
</p>
    </div>
    
  </div>
</footer>
  </body>
</html>